{% extends 'blog/base.html' %}
{% load static %}

{% block page-content %}
      <div class="main-inner">
   <div class="content-wrap">
    <div id="content" class="content">
     <div id="posts" class="posts-expand">
      <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article" style="opacity: 1; display: block; transform: translateY(0px);">
       <link itemprop="mainEntityOfPage" href="http://www.ezlippi.com/blog/2018/04/elasticsearch-translog.html" />
       <span style="display:none" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <meta itemprop="name" content="EZLippi" />
        <meta itemprop="description" content="" />
        <meta itemprop="image" content="/images/avatar.gif" /> </span>
       <span style="display:none" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="EZLippi-浮生志" /> <span style="display:none" itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject"> <a href="./Elasticsearch translog文件介绍 _ EZLippi-浮生志_files/avatar.jpg" class="fancybox" rel="group"><img style="display:none;" itemprop="url image" alt="EZLippi-浮生志" src="./Elasticsearch translog文件介绍 _ EZLippi-浮生志_files/avatar.jpg" /></a> </span> </span>
       <header class="post-header">
        <h2 class="post-title" itemprop="name headline"> Elasticsearch translog文件介绍 </h2>
        <div class="post-meta">
         <span class="post-time"> <span class="post-meta-item-icon"> <i class="fa fa-calendar-o"></i> </span> <span class="post-meta-item-text">发表于</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-24T15:38:32+08:00"> 2018-04-24 </time> </span>
         <span class="post-category"> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"> <i class="fa fa-folder-o"></i> </span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"> <a href="https://www.ezlippi.com/categories/JVM/" itemprop="url" rel="index"> <span itemprop="name">JVM</span> </a> </span> </span>
         <span id="/blog/2018/04/elasticsearch-translog.html" class="leancloud_visitors" data-flag-title="Elasticsearch translog文件介绍"> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"> <i class="fa fa-eye"></i> </span> <span class="post-meta-item-text">热度 </span> <span class="leancloud-visitors-count">259</span> <span>℃</span> </span>
         <div class="post-wordcount">
          <span class="post-meta-item-icon"> <i class="fa fa-file-word-o"></i> </span>
          <span class="post-meta-item-text">字数统计</span>
          <span title="字数统计"> 1,399 </span>
          <span class="post-meta-divider">|</span>
          <span class="post-meta-item-icon"> <i class="fa fa-clock-o"></i> </span>
          <span class="post-meta-item-text">阅读时长</span>
          <span title="阅读时长"> 5 </span>
         </div>
        </div>
       </header>
       <div class="post-body" itemprop="articleBody">
        <p>这篇文章主要介绍Elasticsearch的索引工作机制,它是如何利用translog来保证数据的安全,以及我们在生产环境中如何优化translog的参数来最大化性能,主要会介绍到elastic中常见的2个操作:refresh和flush，以及这2个接口是如何保证数据能够被检索到的。</p>
        <a id="more"></a>
        <h2 id="数据持久化"><a href="https://www.ezlippi.com/blog/2018/04/elasticsearch-translog.html#%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96" class="headerlink" title="数据持久化"></a>数据持久化</h2>
        <p>我们把数据写到磁盘后,还要调用fsync才能把数据刷到磁盘中,如果不这样做在系统掉电的时候就会导致数据丢失,这个原理相信大家都清楚,elasticsearch为了高可靠性必须把所有的修改持久化到磁盘中。</p>
        <p>elastic底层采用的是lucene这个库来实现倒排索引的功能,在lucene的概念里每一条记录称为document(文档),lucene使用segment(分段)来存储数据,用commit point来记录所有segment的元数据，一条记录要被搜索到,必须写入到segment中,这一点非常重要,后面会介绍为什么elastic搜索是near-realtime(接近实时的)而不是实时的。</p>
        <p>elastic使用translog来记录所有的操作,我们称之为write-ahead-log，我们新增了一条记录时，es会把数据写到translog和in-memory buffer(内存缓存区)中,如下图所示:</p>
        <p><a href="./Elasticsearch translog文件介绍 _ EZLippi-浮生志_files/1.png" class="fancybox" rel="group"><img src="./Elasticsearch translog文件介绍 _ EZLippi-浮生志_files/1.png" alt="" /></a></p>
        <p>内存缓存区和translog就是near-realtime的关键所在，前面我们讲过新增的索引必须写入到segment后才能被搜索到，因此我们把数据写入到内存缓冲区之后并不能被搜索到,如果希望该文档能立刻被搜索，需要手动调用refresh操作。</p>
        <h2 id="refresh操作"><a href="https://www.ezlippi.com/blog/2018/04/elasticsearch-translog.html#refresh%E6%93%8D%E4%BD%9C" class="headerlink" title="refresh操作"></a>refresh操作</h2>
        <p>默认情况下,es每隔一秒钟执行一次refresh，可以通过参数<code>index.refresh_interval</code>来修改这个刷新间隔，执行refresh操作具体做了哪些事情呢?</p>
        <ul>
         <li>所有在内存缓冲区中的文档被写入到一个新的segment中,但是没有调用fsync,因此内存中的数据可能丢失</li>
         <li>segment被打开使得里面的文档能够被搜索到</li>
         <li>清空内存缓冲区</li>
        </ul>
        <p>执行refresh后的状态如下图所示:</p>
        <p><a href="./Elasticsearch translog文件介绍 _ EZLippi-浮生志_files/2.png" class="fancybox" rel="group"><img src="./Elasticsearch translog文件介绍 _ EZLippi-浮生志_files/2.png" alt="" /></a></p>
        <p>refresh的开销比较大,我在自己环境上测试10W条记录的场景下refresh一次大概要14ms,因此在批量构建索引时可以把refresh间隔设置成-1来临时关闭refresh,等到索引都提交完成之后再打开refresh,可以通过如下接口修改这个参数:</p>
        <figure class="highlight bash">
         <table>
          <tbody>
           <tr>
            <td class="gutter"><pre><span class="line">1</span><br /><span class="line">2</span><br /><span class="line">3</span><br /><span class="line">4</span><br /><span class="line">5</span><br /></pre></td>
            <td class="code"><pre><span class="line">curl -XPUT <span class="string">'localhost:9200/test/_settings'</span> <span class="_">-d</span> <span class="string">'{</span><br /><span class="line">    &quot;index&quot; : {</span><br /><span class="line">        &quot;refresh_interval&quot; : &quot;-1&quot;</span><br /><span class="line">    }</span><br /><span class="line">}'</span></span><br /></pre></td>
           </tr>
          </tbody>
         </table>
        </figure>
        <p>另外当你在做批量索引时,可以考虑把副本数设置成0，因为document从主分片(primary shard)复制到从分片(replica shard)时,从分片也要执行相同的分析、索引和合并过程,这样的开销比较大，你可以在构建索引之后再开启副本，这样只需要把数据从主分片拷贝到从分片:</p>
        <figure class="highlight bash">
         <table>
          <tbody>
           <tr>
            <td class="gutter"><pre><span class="line">1</span><br /><span class="line">2</span><br /><span class="line">3</span><br /><span class="line">4</span><br /><span class="line">5</span><br /></pre></td>
            <td class="code"><pre><span class="line">curl -XPUT <span class="string">'localhost:9200/my_index/_settings'</span> <span class="_">-d</span> <span class="string">' {</span><br /><span class="line">    &quot;index&quot; : {</span><br /><span class="line">        &quot;number_of_replicas&quot; : 0</span><br /><span class="line">    }</span><br /><span class="line">}'</span></span><br /></pre></td>
           </tr>
          </tbody>
         </table>
        </figure>
        <p>执行完批量索引之后,把刷新间隔改回来:</p>
        <figure class="highlight bash">
         <table>
          <tbody>
           <tr>
            <td class="gutter"><pre><span class="line">1</span><br /><span class="line">2</span><br /><span class="line">3</span><br /><span class="line">4</span><br /><span class="line">5</span><br /></pre></td>
            <td class="code"><pre><span class="line">curl -XPUT <span class="string">'localhost:9200/my_index/_settings'</span> <span class="_">-d</span> <span class="string">'{</span><br /><span class="line">    &quot;index&quot; : {</span><br /><span class="line">        &quot;refresh_interval&quot; : &quot;1s&quot;</span><br /><span class="line">    } </span><br /><span class="line">}'</span></span><br /></pre></td>
           </tr>
          </tbody>
         </table>
        </figure>
        <p>你还可以强制执行一次refresh以及索引分段的合并:</p>
        <figure class="highlight bash">
         <table>
          <tbody>
           <tr>
            <td class="gutter"><pre><span class="line">1</span><br /><span class="line">2</span><br /></pre></td>
            <td class="code"><pre><span class="line">curl -XPOST <span class="string">'localhost:9200/my_index/_refresh'</span></span><br /><span class="line">curl -XPOST <span class="string">'localhost:9200/my_index/_forcemerge?max_num_segments=5'</span></span><br /></pre></td>
           </tr>
          </tbody>
         </table>
        </figure>
        <h2 id="flush操作"><a href="https://www.ezlippi.com/blog/2018/04/elasticsearch-translog.html#flush%E6%93%8D%E4%BD%9C" class="headerlink" title="flush操作"></a>flush操作</h2>
        <p>随着translog文件越来越大时要考虑把内存中的数据刷新到磁盘中，这个过程称为flush，flush过程主要做了如下操作:</p>
        <ul>
         <li>把所有在内存缓冲区中的文档写入到一个新的segment中</li>
         <li>清空内存缓冲区</li>
         <li>往磁盘里写入commit point信息</li>
         <li>文件系统的page cache(segments) fsync到磁盘</li>
         <li>删除旧的translog文件，因此此时内存中的segments已经写入到磁盘中,就不需要translog来保障数据安全了</li>
        </ul>
        <p>flush之后的状态如下所示:</p>
        <p><a href="./Elasticsearch translog文件介绍 _ EZLippi-浮生志_files/4.png" class="fancybox" rel="group"><img src="./Elasticsearch translog文件介绍 _ EZLippi-浮生志_files/4.png" alt="" /></a></p>
        <p>es有几个条件来决定是否flush到磁盘,不同版本的es参数有所不同，大家可以参考es对应版本的文档来查看这几个参数:<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules-translog.html" target="_blank" rel="external">es translog</a>,这里介绍下1.7版本的flush参数:</p>
        <ul>
         <li>index.translog.flush_threshold_ops,执行多少次操作后执行一次flush，默认无限制</li>
         <li>index.translog.flush_threshold_size，translog的大小超过这个参数后flush，默认512mb</li>
         <li>index.translog.flush_threshold_period,多长时间强制flush一次,默认30m</li>
         <li>index.translog.interval,es多久去检测一次translog是否满足flush条件</li>
        </ul>
        <p>上面的参数是es多久执行一次flush操作,在系统恢复过程中es会比较translog和segments中的数据来保证数据的完整性,为了数据安全es默认每隔5秒钟会把translog刷新(fsync)到磁盘中,也就是说系统掉电的情况下es最多会丢失5秒钟的数据,如果你对数据安全比较敏感,可以把这个间隔减小或者改为每次请求之后都把translog fsync到磁盘,但是会占用更多资源；这个间隔是通过下面2个参数来控制的:</p>
        <ul>
         <li>index.translog.sync_interval 控制translog多久fsync到磁盘,最小为100ms</li>
         <li>index.translog.durability translog是每5秒钟刷新一次还是每次请求都fsync，这个参数有2个取值:request(每次请求都执行fsync,es要等translog fsync到磁盘后才会返回成功)和async(默认值,translog每隔5秒钟fsync一次)</li>
        </ul>
        <p>读者需要弄清楚flush和fsync的区别,flush是把内存中的数据(包括translog和segments)都刷到磁盘,而fsync只是把translog刷新的磁盘(确保数据不丢失)。<br />最后附上一个实用的elastic配置文件<a href="https://github.com/EZLippi/Profiles/blob/master/java/elasticsearch.yml" target="_blank" rel="external">https://github.com/EZLippi/Profiles/blob/master/java/elasticsearch.yml</a>。</p>
       </div>
       <div>
       </div>
       <div class="post-tags">
        <a href="https://www.ezlippi.com/tags/Java/" rel="tag"># Java</a>
        <a href="https://www.ezlippi.com/tags/JVM/" rel="tag"># JVM</a>
        <a href="https://www.ezlippi.com/tags/Elasticsearch/" rel="tag"># Elasticsearch</a>
        <a href="https://www.ezlippi.com/tags/translog/" rel="tag"># translog</a>
       </div>
       <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
         <div>
          &#55357;&#56374; 您的支持将鼓励我继续创作 &#55357;&#56374;
         </div>
         <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}"> <span>赞赏</span> </button>
         <div id="QR" style="display: none;">
          <div id="wechat" style="display: inline-block">
           <a href="./Elasticsearch translog文件介绍 _ EZLippi-浮生志_files/wechat-reward-img.jpg" class="fancybox" rel="group"><img id="wechat_qr" src="./Elasticsearch translog文件介绍 _ EZLippi-浮生志_files/wechat-reward-img.jpg" alt="EZLippi WeChat Pay" /></a>
           <p>微信打赏</p>
          </div>
          <div id="alipay" style="display: inline-block">
           <a href="./Elasticsearch translog文件介绍 _ EZLippi-浮生志_files/alipay-reward-img.jpg" class="fancybox" rel="group"><img id="alipay_qr" src="./Elasticsearch translog文件介绍 _ EZLippi-浮生志_files/alipay-reward-img.jpg" alt="EZLippi Alipay" /></a>
           <p>支付宝打赏</p>
          </div>
         </div>
        </div>
       </div>
       <footer class="post-footer">
        <div>
         <ul class="post-copyright">
          <li class="post-copyright-link"> <strong>本文作者：</strong> <a href="https://www.ezlippi.com/" title="欢迎访问 EZLippi 的个人博客">EZLippi</a> </li>
          <li class="post-copyright-link"> <strong>本文标题：</strong> <a href="http://www.ezlippi.com/blog/2018/04/elasticsearch-translog.html" title="Elasticsearch translog文件介绍">Elasticsearch translog文件介绍</a> </li>
          <li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://www.ezlippi.com/blog/2018/04/elasticsearch-translog.html" title="Elasticsearch translog文件介绍">http://www.ezlippi.com/blog/2018/04/elasticsearch-translog.html</a> </li>
          <li class="post-copyright-date"> <strong>发布时间：</strong>2018年4月24日 - 15时04分 </li>
          <li class="post-copyright-license"> <strong>版权声明： </strong> 本文由 EZLippi 原创，采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="license" target="_blank">保留署名-非商业性使用-禁止演绎 4.0-国际许可协议</a> <br />转载请保留以上声明信息！ </li>
         </ul>
        </div>
        <div class="post-nav">
         <div class="post-nav-next post-nav-item">
          <a href="https://www.ezlippi.com/blog/2018/04/mysql-settings.html" rel="next" title="MySQL常用参数列表"> <i class="fa fa-chevron-left"></i> MySQL常用参数列表 </a>
         </div>
         <span class="post-nav-divider"></span>
         <div class="post-nav-prev post-nav-item">
         </div>
        </div>
       </footer>
      </article>
      <div class="post-spread">
      </div>
     </div>
    </div>
    <div class="comments" id="comments">
     <div id="lv-container" data-id="city" data-uid="MTAyMC8zMjI4My84ODQ3"></div>
    </div>
   </div>
  </div>
{% endblock %}

{% block blog_index_nav %}
    <ul class="sidebar-nav motion-element" style="opacity: 1; display: block; transform: translateX(0px);">
      <li class="sidebar-nav-toc" data-target="post-toc-wrap"> 文章目录 </li>
      <li class="sidebar-nav-overview sidebar-nav-active" data-target="site-overview"> 站点概览 </li>
     </ul>
{% endblock %}


{% block blog_index_content %}
    <!--noindex-->
     <section class="post-toc-wrap motion-element sidebar-panel" style="opacity: 1; display: block; transform: translateX(0px);">
      <div class="post-toc" style="max-height: 849px; width: calc(100% + 17px);">
       <div class="post-toc-content">
        <ol class="nav">
         <li class="nav-item nav-level-2"><a class="nav-link" href="https://www.ezlippi.com/blog/2018/04/elasticsearch-translog.html#%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">1.</span> <span class="nav-text">数据持久化</span></a></li>
         <li class="nav-item nav-level-2"><a class="nav-link" href="https://www.ezlippi.com/blog/2018/04/elasticsearch-translog.html#refresh%E6%93%8D%E4%BD%9C"><span class="nav-number">2.</span> <span class="nav-text">refresh操作</span></a></li>
         <li class="nav-item nav-level-2"><a class="nav-link" href="https://www.ezlippi.com/blog/2018/04/elasticsearch-translog.html#flush%E6%93%8D%E4%BD%9C"><span class="nav-number">3.</span> <span class="nav-text">flush操作</span></a></li>
        </ol>
       </div>
      </div>
     </section>
     <!--/noindex-->
{% endblock %}